<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
	<link rel="manifest" href="/manifest.json">
	<script>
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/service-worker.js').catch(() => {});
		}
	</script>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>Universal Video Downloader</title>
	<meta name="theme-color" content="#0d1117" />
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
	<link rel="icon" type="image/png" href="/static/logo.png" />
	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<style>
		:root {
			--bg: #050a17;
			--bg-alt: #091021;
			--card: rgba(15, 23, 42, 0.87);
			--panel: rgba(15, 23, 42, 0.78);
			--text: #f8fafc;
			--muted: #a1accb;
			--highlight: #00bcd4;
			--accent: #6366f1;
			--border: rgba(148, 163, 184, 0.22);
			--shadow: 0 20px 40px rgba(3, 7, 18, 0.45);
		}
		[data-theme="light"] {
			--bg: linear-gradient(180deg, #f4f7fb 0%, #e2e8f0 100%);
			--bg-alt: #f1f5f9;
			--card: rgba(255, 255, 255, 0.92);
			--panel: rgba(255, 255, 255, 0.88);
			--text: #0f172a;
			--muted: #475569;
			--highlight: #0087d4;
			--accent: #3b82f6;
			--border: rgba(15, 23, 42, 0.12);
			--shadow: 0 16px 32px rgba(15, 23, 42, 0.15);
		}
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Poppins', sans-serif;
			-webkit-font-smoothing: antialiased;
		}
		body {
			background: var(--bg);
			color: var(--text);
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: flex-start;
			padding: 2.5rem;
			position: relative;
			overflow-x: hidden;
			transition: background 0.4s ease;
		}
		video#bgVideo {
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			object-fit: cover;
			z-index: -2;
			opacity: 0.18;
		}
		.page-shell {
			width: min(1120px, 100%);
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 1.75rem;
			flex: 1 0 auto;
			margin: 0 auto;
		}
		.theme-toggle {
			position: fixed;
			top: 1.25rem;
			right: 1.25rem;
			background: rgba(15, 23, 42, 0.6);
			border: 1px solid var(--border);
			color: var(--text);
			padding: 0.55rem 1.25rem;
			border-radius: 999px;
			cursor: pointer;
			font-weight: 600;
			letter-spacing: 0.02em;
			transition: all 0.25s ease;
			backdrop-filter: blur(10px);
		}
		.theme-toggle:hover {
			transform: translateY(-2px);
			border-color: var(--highlight);
			color: var(--highlight);
		}
		.card {
			width: min(760px, 100%);
			background: var(--card);
			backdrop-filter: blur(18px);
			border: 1px solid var(--border);
			border-radius: 28px;
			box-shadow: var(--shadow);
			padding: 2.75rem clamp(1.5rem, 4vw, 3rem);
			display: flex;
			flex-direction: column;
			gap: 1.75rem;
		}
		.card-body {
			display: flex;
			flex-direction: column;
			gap: 1.5rem;
		}
		.interaction-column {
			display: flex;
			flex-direction: column;
			gap: 1.1rem;
		}
		.card-header h1 {
			font-size: clamp(2rem, 4vw, 2.75rem);
			font-weight: 700;
			margin-bottom: 0.35rem;
			color: var(--highlight);
		}
		.card-header .subtitle {
			font-size: 1rem;
			color: var(--muted);
		}
		.metrics {
			display: grid;
			grid-template-columns: repeat(2, minmax(0, 1fr));
			gap: 1rem;
		}
		.metric {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--border);
			border-radius: 18px;
			padding: 1rem 1.25rem;
			display: flex;
			flex-direction: column;
			gap: 0.25rem;
		}
		.metric-label {
			font-size: 0.85rem;
			text-transform: uppercase;
			letter-spacing: 0.08em;
			color: var(--muted);
		}
		.metric-value {
			font-size: 1.65rem;
			font-weight: 700;
			color: var(--text);
		}
		form {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}
		.form-control label {
			font-size: 0.9rem;
			font-weight: 600;
			margin-bottom: 0.5rem;
			display: block;
			color: var(--muted);
		}
		.input-field {
			width: 100%;
			border-radius: 16px;
			border: 1px solid transparent;
			padding: 0.95rem 1.1rem;
			font-size: 1rem;
			color: var(--text);
			background: rgba(255, 255, 255, 0.08);
			transition: border 0.25s ease, box-shadow 0.25s ease;
		}
		.input-field:focus {
			outline: none;
			border-color: var(--highlight);
			box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.25);
		}
		.select-field {
			width: 100%;
			border-radius: 16px;
			border: 1px solid transparent;
			padding: 0.85rem 1.05rem;
			font-size: 0.95rem;
			color: var(--text);
			background: rgba(255, 255, 255, 0.08);
			transition: border 0.25s ease;
		}
		.select-field:disabled {
			opacity: 0.65;
			cursor: not-allowed;
		}
		.cta-row {
			display: flex;
			flex-wrap: wrap;
			gap: 0.8rem;
			justify-content: center;
		}
		.btn {
			padding: 0.85rem 1.9rem;
			border-radius: 999px;
			border: none;
			font-weight: 600;
			font-size: 0.95rem;
			letter-spacing: 0.01em;
			cursor: pointer;
			transition: transform 0.25s ease, box-shadow 0.25s ease, opacity 0.25s;
			color: #fff;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
		}
		.btn-primary {
			background: linear-gradient(135deg, var(--highlight), var(--accent));
			box-shadow: 0 12px 24px rgba(99, 102, 241, 0.3);
		}
		.btn-secondary {
			background: rgba(99, 102, 241, 0.18);
			border: 1px solid rgba(99, 102, 241, 0.35);
		}
		.btn:disabled {
			cursor: not-allowed;
			opacity: 0.6;
			transform: none !important;
			box-shadow: none;
		}
		.btn:hover:not(:disabled) {
			transform: translateY(-2px);
		}
		.status-row {
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 26px;
			font-size: 0.95rem;
			color: var(--muted);
		}
		.progress-track {
			display: none;
			flex-direction: column;
			gap: 0.6rem;
			margin-top: 0.5rem;
			background: rgba(99, 102, 241, 0.14);
			border: 1px solid var(--border);
			border-radius: 16px;
			padding: 1rem 1.2rem;
		}
		.progress-track.is-error {
			background: rgba(239, 68, 68, 0.12);
			border-color: rgba(239, 68, 68, 0.5);
		}
		.progress-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-size: 0.85rem;
			color: var(--muted);
		}
		.progress-bar {
			width: 100%;
			height: 9px;
			border-radius: 999px;
			overflow: hidden;
			background: rgba(255, 255, 255, 0.08);
		}
		.progress-fill {
			height: 100%;
			width: 0%;
			border-radius: 999px;
			background: linear-gradient(135deg, var(--highlight), var(--accent));
			transition: width 0.25s ease;
		}
		.preview {
			display: none;
			flex-direction: column;
			align-items: center;
			gap: 1rem;
			padding: 1.25rem;
			background: rgba(255, 255, 255, 0.05);
			border-radius: 18px;
			border: 1px solid var(--border);
			text-align: center;
			align-self: center;
			width: 100%;
			max-width: 320px;
		}
		.preview img {
			width: min(100%, 360px);
			border-radius: 18px;
			box-shadow: 0 18px 32px rgba(2, 6, 23, 0.45);
		}
		.preview-title {
			font-size: 1.1rem;
			font-weight: 600;
		}
		.panel-grid {
			width: min(1120px, 100%);
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			gap: 1.5rem;
		}
		.panel {
			background: var(--panel);
			border-radius: 24px;
			border: 1px solid var(--border);
			padding: 1.75rem;
			backdrop-filter: blur(12px);
			box-shadow: var(--shadow);
		}
		.panel h2 {
			font-size: 1.15rem;
			font-weight: 600;
			margin-bottom: 1rem;
			color: var(--highlight);
		}
		.history-list {
			list-style: none;
			display: flex;
			flex-direction: column;
			gap: 0.85rem;
			max-height: 220px;
			overflow-y: auto;
			padding-right: 0.5rem;
		}
		.history-list li {
			display: flex;
			flex-direction: column;
			gap: 0.2rem;
			background: rgba(15, 23, 42, 0.45);
			border: 1px solid rgba(148, 163, 184, 0.18);
			border-radius: 14px;
			padding: 0.85rem 1rem;
		}
		.history-title {
			font-weight: 600;
			font-size: 0.98rem;
			color: var(--text);
		}
		.history-meta {
			font-size: 0.82rem;
			color: var(--muted);
		}
		.history-empty {
			text-align: center;
			color: var(--muted);
			font-size: 0.9rem;
			border: 1px dashed rgba(148, 163, 184, 0.25);
			padding: 1rem;
			border-radius: 14px;
			background: rgba(15, 23, 42, 0.35);
		}
		.analytics-list {
			list-style: none;
			display: flex;
			flex-direction: column;
			gap: 0.85rem;
		}
		.analytics-list li {
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-size: 0.95rem;
			color: var(--muted);
			padding: 0.65rem 0;
			border-bottom: 1px solid rgba(148, 163, 184, 0.12);
		}
		.analytics-list li:last-child {
			border-bottom: none;
		}
		.analytics-list strong {
			font-size: 1.2rem;
			color: var(--text);
		}
		.translate-panel p {
			font-size: 0.95rem;
			color: var(--muted);
			line-height: 1.5;
		}
		footer {
			width: 100%;
			text-align: center;
			font-size: 0.85rem;
			color: var(--muted);
			margin-top: auto;
		}
		footer a {
			color: var(--highlight);
			text-decoration: none;
			font-weight: 600;
		}
		footer a:hover {
			text-decoration: underline;
		}
		@media (max-width: 1024px) {
			body {
				padding: 2rem;
			}
			.theme-toggle {
				position: absolute;
			}
		}
		@media (max-width: 768px) {
			body {
				padding: 1.75rem;
			}
			.metrics {
				grid-template-columns: 1fr;
			}
			.card {
				padding: 2.25rem 1.65rem;
			}
			.cta-row {
				flex-direction: column;
			}
		}
		@media (max-width: 540px) {
			body {
				padding: 1.25rem;
			}
			.theme-toggle {
				top: 1rem;
				right: 1rem;
				bottom: auto;
				transform: none;
				padding: 0.45rem 0.95rem;
				font-size: 0.85rem;
			}
			.card {
				padding: 2rem 1.4rem;
			}
		}
		@media (min-width: 960px) {
			.card {
				width: min(900px, 100%);
			}
			.card-body.with-preview {
				display: grid;
				grid-template-columns: minmax(0, 1fr) minmax(260px, 320px);
				align-items: flex-start;
				gap: 2rem;
			}
			.preview {
				align-self: flex-start;
				text-align: left;
			}
		}
	</style>
</head>
<body>
	<video autoplay muted loop id="bgVideo">
		<source src="/static/bg.mp4" type="video/mp4">
	</video>
	<button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
	<main class="page-shell">
		<section class="card">
			<div class="card-header">
				<div id="g_id_onload"
						 data-client_id="800453770887-prhbr8h8394e9q29fgsch09a2dh0rr2d.apps.googleusercontent.com"
						 data-callback="handleGoogleLogin"
						 data-auto_prompt="false"></div>
				<div class="g_id_signin" data-type="standard"></div>
				<h1>üì• Universal Downloader</h1>
				<p class="subtitle">Clean. Fast. Reliable. Bring any link, choose the quality, and get a pristine download with embedded artwork.</p>
			</div>
			<section class="metrics">
				<div class="metric">
					<span class="metric-label">üìä Downloads</span>
					<span class="metric-value" id="downloads-count">4,836</span>
				</div>
				<div class="metric">
					<span class="metric-label">üë• Total Users</span>
					<span class="metric-value" id="users-count">218</span>
				</div>
			</section>
			<div class="card-body" id="card-body">
				<div class="interaction-column">
					<form id="download-form" method="POST" action="/download">
						<div class="form-control">
							<label for="url">Paste URL</label>
							<input type="text" id="url" name="url" class="input-field" placeholder="https://youtu.be/example or https://open.spotify.com/track/..." required>
						</div>
						<div class="form-control">
							<label for="format">Choose Format</label>
							<select name="format" id="format" class="select-field" disabled>
								<option value="best">Click "Fetch Qualities" first</option>
							</select>
						</div>
						<div class="cta-row">
							<button type="button" class="btn btn-secondary" id="fetch-button">
								<i class="fa-solid fa-magnifying-glass"></i> Fetch Qualities
							</button>
							<button type="submit" class="btn btn-primary" id="download-button" style="display:none;">
								<i class="fa-solid fa-download"></i> Download
							</button>
						</div>
					</form>
					<div class="status-row" id="loader" style="display:none;">‚è≥ Fetching formats‚Ä¶</div>
					<div class="progress-track" id="progress-track" aria-hidden="true">
						<div class="progress-header">
							<span id="progress-label">Preparing download...</span>
							<span id="progress-percent">0%</span>
						</div>
						<div class="progress-bar">
							<div class="progress-fill" id="progress-fill"></div>
						</div>
					</div>
				</div>
				<div class="preview" id="video-preview">
					<img id="video-thumbnail" src="" alt="Video thumbnail">
					<span class="preview-title" id="video-title"></span>
				</div>
			</div>
		</section>

		<section class="panel-grid">
			<div class="panel" id="dashboard-panel">
				<h2>üë§ User Dashboard</h2>
				<ul class="history-list" id="history-list"></ul>
			</div>
			<div class="panel">
				<h2>üì§ Admin Analytics</h2>
				<ul class="analytics-list">
					<li><span>All-time Downloads</span><strong id="admin-downloads-count">4,836</strong></li>
					<li><span>Active Users</span><strong id="admin-users-count">218</strong></li>
				</ul>
			</div>
			<div class="panel translate-panel">
				<h2>üåç Adaptive Language</h2>
				<p>This interface automatically adapts to your locale (<strong><span id="browser-language"></span></strong>) so users across the globe get a consistent premium experience.</p>
			</div>
		</section>
	</main>
	<footer>
		Made with <span style="color:#ef4444;">‚ù§</span> by <strong>Alex ü•Ä</strong> ‚Äî <a href="https://t.me/daraggggggg" target="_blank" rel="noopener">Telegram</a>
	</footer>

	<script>
		document.getElementById('browser-language').textContent = navigator.language || 'en-US';

		const formatSelect = document.getElementById('format');
		const downloadButton = document.getElementById('download-button');
		const fetchButton = document.getElementById('fetch-button');
		const urlInput = document.getElementById('url');
		const previewContainer = document.getElementById('video-preview');
		const thumbnailImg = document.getElementById('video-thumbnail');
		const titleSpan = document.getElementById('video-title');
		const loader = document.getElementById('loader');
		const downloadForm = document.getElementById('download-form');
		const downloadsCounter = document.getElementById('downloads-count');
		const usersCounter = document.getElementById('users-count');
		const adminDownloadsCounter = document.getElementById('admin-downloads-count');
		const adminUsersCounter = document.getElementById('admin-users-count');
		const historyList = document.getElementById('history-list');
		const cardBody = document.getElementById('card-body');
		const progressTrack = document.getElementById('progress-track');
		const progressFill = document.getElementById('progress-fill');
		const progressLabel = document.getElementById('progress-label');
		const progressPercent = document.getElementById('progress-percent');

		const METRICS_KEY = 'uvd-metrics-v1';
		const HISTORY_KEY = 'uvd-history-v1';
		const USER_TRACK_KEY = 'uvd-user-counted';
		const INITIAL_METRICS = { downloads: 4836, users: 218 };

		let metrics = { ...INITIAL_METRICS };
		let history = [];
		let lastPreview = null;
		let isDownloading = false;
		let activeJobId = null;
		let statusPoll = null;
		let hideProgressTimer = null;
		let pendingFormatLabel = 'Best Quality';

		function loadMetrics() {
			try {
				const saved = JSON.parse(localStorage.getItem(METRICS_KEY) || '{}');
				if (typeof saved.downloads === 'number') {
					metrics.downloads = Math.max(INITIAL_METRICS.downloads, saved.downloads);
				}
				if (typeof saved.users === 'number') {
					metrics.users = Math.max(INITIAL_METRICS.users, saved.users);
				}
			} catch (_) {
				metrics = { ...INITIAL_METRICS };
			}
		}

		function persistMetrics() {
			localStorage.setItem(METRICS_KEY, JSON.stringify(metrics));
		}

		function syncMetrics() {
			const downloadsText = metrics.downloads.toLocaleString();
			const usersText = metrics.users.toLocaleString();
			downloadsCounter.textContent = downloadsText;
			usersCounter.textContent = usersText;
			adminDownloadsCounter.textContent = downloadsText;
			adminUsersCounter.textContent = usersText;
		}

		function loadHistory() {
			try {
				history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
				if (!Array.isArray(history)) {
					history = [];
				}
			} catch (_) {
				history = [];
			}
		}

		function persistHistory() {
			localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
		}

		function renderHistory() {
			historyList.innerHTML = '';
			if (!history.length) {
				const empty = document.createElement('li');
				empty.className = 'history-empty';
				empty.textContent = 'No downloads yet in this browser.';
				historyList.appendChild(empty);
				return;
			}
			history.slice(0, 6).forEach(entry => {
				const li = document.createElement('li');
				const title = document.createElement('span');
				title.className = 'history-title';
				title.textContent = entry.title || 'Untitled';
				const meta = document.createElement('span');
				meta.className = 'history-meta';
				const tag = entry.tag ? ` ‚Ä¢ ${entry.tag}` : '';
				meta.textContent = `${entry.format} ‚Ä¢ ${entry.timestamp}${tag}`;
				li.appendChild(title);
				li.appendChild(meta);
				historyList.appendChild(li);
			});
		}

		function clearPolling() {
			if (statusPoll) {
				clearTimeout(statusPoll);
				statusPoll = null;
			}
		}

		function hideProgressUI() {
			if (hideProgressTimer) {
				clearTimeout(hideProgressTimer);
				hideProgressTimer = null;
			}
			progressTrack.style.display = 'none';
			progressTrack.setAttribute('aria-hidden', 'true');
			progressTrack.classList.remove('is-error');
			progressFill.style.width = '0%';
			progressPercent.textContent = '0%';
			progressLabel.textContent = '';
		}

		function showProgressUI(progress = 0, message = 'Preparing download...') {
			if (hideProgressTimer) {
				clearTimeout(hideProgressTimer);
				hideProgressTimer = null;
			}
			progressTrack.style.display = 'flex';
			progressTrack.setAttribute('aria-hidden', 'false');
			progressTrack.classList.remove('is-error');
			updateProgressUI(progress, message);
		}

		function updateProgressUI(progress, message) {
			if (typeof progress === 'number' && !Number.isNaN(progress)) {
				const clamped = Math.max(0, Math.min(100, Math.round(progress)));
				progressFill.style.width = clamped + '%';
				progressPercent.textContent = clamped + '%';
			} else if (progress === null) {
				progressPercent.textContent = '--';
			}
			if (message) {
				progressLabel.textContent = message;
			}
		}

		function addHistoryEntry(entry) {
			history.unshift(entry);
			if (history.length > 12) {
				history = history.slice(0, 12);
			}
			persistHistory();
			renderHistory();
		}

		function resetUI() {
			clearPolling();
			hideProgressUI();
			previewContainer.style.display = 'none';
			cardBody.classList.remove('with-preview');
			thumbnailImg.src = '';
			titleSpan.textContent = '';
			downloadButton.style.display = 'none';
			downloadButton.textContent = 'Download';
			downloadButton.disabled = true;
			fetchButton.disabled = false;
			formatSelect.disabled = true;
			formatSelect.innerHTML = '<option value="best">Click "Fetch Qualities" first</option>';
			loader.style.display = 'none';
			lastPreview = null;
			pendingFormatLabel = 'Best Quality';
			isDownloading = false;
			activeJobId = null;
		}

		function isSpotify(url) {
			const lowered = url.toLowerCase();
			return lowered.includes('open.spotify.com') || lowered.startsWith('spotify:');
		}

		function finishDownload(isError = false) {
			clearPolling();
			activeJobId = null;
			isDownloading = false;
			fetchButton.disabled = false;
			if (downloadButton.style.display !== 'none') {
				downloadButton.disabled = false;
				downloadButton.textContent = lastPreview && lastPreview.isSpotify ? 'Download Spotify' : 'Download';
			}
			pendingFormatLabel = 'Best Quality';
			if (isError) {
				return;
			}
			if (hideProgressTimer) {
				clearTimeout(hideProgressTimer);
			}
			hideProgressTimer = setTimeout(hideProgressUI, 1600);
		}

		function recordDownload(formatLabel) {
			metrics.downloads += 1;
			if (!localStorage.getItem(USER_TRACK_KEY)) {
				metrics.users += 1;
				localStorage.setItem(USER_TRACK_KEY, 'true');
			}
			persistMetrics();
			syncMetrics();

			if (lastPreview) {
				addHistoryEntry({
					title: lastPreview.title || 'Untitled',
					format: formatLabel,
					timestamp: new Date().toLocaleString(),
					tag: lastPreview.isSpotify ? 'Spotify' : 'Video'
				});
			}
		}

		fetchButton.addEventListener('click', previewVideo);

		urlInput.addEventListener('input', () => {
			if (downloadButton.style.display !== 'none' || lastPreview) {
				resetUI();
			}
		});

		downloadForm.addEventListener('submit', handleDownloadSubmit);

		async function handleDownloadSubmit(event) {
			event.preventDefault();
			if (isDownloading) {
				return;
			}
			clearPolling();
			const url = urlInput.value.trim();
			if (!url) {
				alert('Please paste a URL first.');
				return;
			}
			if (!lastPreview && !isSpotify(url)) {
				alert('Fetch video details first using "Fetch Qualities".');
				return;
			}

			const selectedOption = formatSelect.options[formatSelect.selectedIndex];
			const formatValue = selectedOption ? selectedOption.value : 'best';
			pendingFormatLabel = selectedOption ? selectedOption.textContent : 'Best Quality';

			isDownloading = true;
			fetchButton.disabled = true;
			if (downloadButton.style.display !== 'none') {
				downloadButton.disabled = true;
				downloadButton.textContent = lastPreview && lastPreview.isSpotify ? 'Preparing Spotify...' : 'Starting...';
			}

			showProgressUI(0, 'Preparing download...');
			try {
				const response = await fetch('/start_download', {
					method: 'POST',
					headers: {'Content-Type': 'application/x-www-form-urlencoded'},
					body: new URLSearchParams({ url, format: formatValue })
				});
				const data = await response.json();
				if (!response.ok || !data.jobId) {
					throw new Error(data.error || 'Failed to start download');
				}
				activeJobId = data.jobId;
				await pollStatus();
			} catch (error) {
				progressTrack.classList.add('is-error');
				updateProgressUI(0, `Error: ${error.message || 'Failed to start download'}`);
				finishDownload(true);
			}
		}

		async function pollStatus() {
			if (!activeJobId) {
				return;
			}
			statusPoll = null;
			try {
				const response = await fetch(`/download_status/${activeJobId}`);
				const data = await response.json();
				if (!response.ok) {
					throw new Error(data.error || 'Download failed');
				}
				const progressValue = typeof data.progress === 'number' ? data.progress : null;
				const message = data.message || (progressValue ? 'Downloading...' : 'Preparing download...');
				updateProgressUI(progressValue, message);

				if (data.error || data.status === 'error') {
					progressTrack.classList.add('is-error');
					finishDownload(true);
					return;
				}

				if (data.status === 'completed' && data.downloadUrl) {
					progressTrack.classList.remove('is-error');
					updateProgressUI(100, data.message || 'Download ready');
					triggerDownload(data.downloadUrl);
					recordDownload(pendingFormatLabel);
					finishDownload(false);
					return;
				}

				clearPolling();
				statusPoll = setTimeout(pollStatus, 900);
			} catch (error) {
				progressTrack.classList.add('is-error');
				updateProgressUI(0, `Error: ${error.message || 'Download failed'}`);
				finishDownload(true);
			}
		}

		function triggerDownload(url) {
			if (!url) {
				return;
			}
			const link = document.createElement('a');
			link.href = url;
			link.style.display = 'none';
			link.rel = 'noopener';
			document.body.appendChild(link);
			link.click();
			requestAnimationFrame(() => {
				document.body.removeChild(link);
			});
		}

		function populateFormats(data) {
			formatSelect.innerHTML = '';
			if (data.formats && data.formats.length) {
				data.formats.forEach(fmt => {
					const option = document.createElement('option');
					option.value = fmt.id;
					option.textContent = fmt.label;
					formatSelect.appendChild(option);
				});
			} else {
				const option = document.createElement('option');
				option.value = 'best';
				option.textContent = 'Best Quality';
				formatSelect.appendChild(option);
			}
			formatSelect.disabled = false;
			downloadButton.style.display = 'inline-flex';
			downloadButton.disabled = false;
			downloadButton.textContent = 'Download';
		}

		function previewVideo() {
			const url = urlInput.value.trim();
			if (!url || isDownloading) return;
			hideProgressUI();
			progressTrack.classList.remove('is-error');
			loader.style.display = 'block';
			downloadButton.style.display = 'none';
			downloadButton.disabled = true;
			formatSelect.disabled = true;
			formatSelect.innerHTML = '<option>Loading options‚Ä¶</option>';

			if (isSpotify(url)) {
				fetch('/video_info', {
					method: 'POST',
					headers: {'Content-Type': 'application/x-www-form-urlencoded'},
					body: new URLSearchParams({ url })
				})
					.then(res => res.json())
					.then(data => {
						loader.style.display = 'none';
						if (data.error) {
							alert('‚ùå ' + data.error);
							resetUI();
							return;
						}
						lastPreview = { title: data.title || 'Spotify Track', isSpotify: true };
						previewContainer.style.display = 'flex';
						cardBody.classList.add('with-preview');
						if (data.thumbnail) {
							thumbnailImg.src = data.thumbnail;
						}
						titleSpan.textContent = data.title || 'Spotify Track';
						formatSelect.innerHTML = '<option value="best">Spotify download (MP3)</option>';
						formatSelect.disabled = true;
						downloadButton.style.display = 'inline-flex';
						downloadButton.textContent = 'Download Spotify';
						downloadButton.disabled = false;
					})
					.catch(() => {
						loader.style.display = 'none';
						alert('‚ùå Failed to load Spotify details');
						resetUI();
					});
				return;
			}

			fetch('/video_info', {
				method: 'POST',
				headers: {'Content-Type': 'application/x-www-form-urlencoded'},
				body: new URLSearchParams({ url })
			})
				.then(res => res.json())
				.then(data => {
					loader.style.display = 'none';
					if (data.error) {
						resetUI();
						alert('‚ùå ' + data.error);
						return;
					}
					lastPreview = { title: data.title || url, isSpotify: false };
					previewContainer.style.display = 'flex';
					cardBody.classList.add('with-preview');
					if (data.thumbnail) {
						thumbnailImg.src = data.thumbnail;
					}
					titleSpan.textContent = data.title || 'Untitled Video';
					populateFormats(data);
					if (data.apiFallback) {
						fetchButton.disabled = false;
					}
				})
				.catch(() => {
					loader.style.display = 'none';
					resetUI();
					alert('‚ùå Failed to fetch preview');
				});
		}

		function toggleTheme() {
			const html = document.documentElement;
			const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
			html.setAttribute('data-theme', next);
		}

		function handleGoogleLogin(response) {
			try {
				const profile = JSON.parse(atob(response.credential.split('.')[1]));
				alert('üëã Welcome ' + profile.name);
			} catch (_) {
				alert('üëã Welcome back!');
			}
		}

		loadMetrics();
		loadHistory();
		syncMetrics();
		renderHistory();
		resetUI();
	</script>
</body>
</html>

  
